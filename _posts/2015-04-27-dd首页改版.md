---
layout: post
---
#{{ page.title }}


dd首页这次改版，在我看来主要是在业务上优化，将原有的项目独立出来，做到独立服务器，提高负载和容灾能力
'顺便'改下前端。
本地改版主要涉及：
后端php写tpl，然后楼层根据根据CMS配置加载;
开启导流页，安装APP时点击下载打开APP，否则引导用户下载APP,根据配置跳转下载地址;
首页顶部焦点轮播,楼层广告轮播;
引导页和主页下载提示页关闭后当天零点过期重新显示。
延迟加载推荐品栏目，无限加载。

##APP判断和下载
开发过程中APP跳转和下载算一个小点，推荐品无限加载算是大点，轮播优化也算一点。
这三点值得记录下。
首先说APP跳转和下载判断，其实在做之前看过叶小钗的一篇文章提到判断打开APP和跳转下载这种需求做不了，
但实际上可以，经过一番研究，可以利用Iframe来改src为APP的协议名，来触发唤醒APP，并在iframe上绑定动画事件，
并记录开始时间，监听动画结束时间，和预设值做对比。知乎的‘移动端利用iframe’下面就有一个回答是这样。
研究下京东的跳转，好像是通过安卓系统的internet://的协议来指定com.jd这样来唤醒客户端（未证实，仅猜测），下载功能做的也比较完善，还利用chrome的下载协议。

##轮播优化
看到淘宝京东都是自己框架下的轮播组件，说实话DD也应该封一个DD的库，包含核心功能和常用功能，把什么zepto,iscroll,fastclick都整合进来，最好再加上require。
不过这个事暂时还推动不起来，在前端很少的情况下，写这些反而降低了效率，在跨团队合作时还是挺有必要的。
DD首页轮播采用Iscroll来实现简单区域滑动，关键的计时器轮播逻辑和左右滑切页自己扩展，
具体参考dd_index/mdd_index.js slideInit()方法，对Iscroll实例进行扩展

##无限加载
无限加载面临最大问题是内存溢出，参看源生客户端竞品，也只是翻几页后跳转新页，并没有完全无限加载。
推荐商品还是用Iscroll来实现滑动部分逻辑，剩下自己扩展。
关键是要维护一个当前的页码，开始尝试用Iscroll的snap自动分页，发现有坑，iscroll会自动对touchend封装一个flick事件，滑动结束，自动给你跳转下一页，这样就局限很多，而且必须一页一页翻。
而自己实现页码分页的话，就没有这些限制了。
 var rem = $('html').css("font-size").replace('px',"");
            window.rec_prds = {
                pageSize:4,
                currentPageNum:1,
                maxPageNum:1,
                liWidth : 5.25 * rem,
                pageWidth: 4 * 5.25 * rem
            }
            // pagesize 为4 首屏加载两页
            this.loadRecPrds(1, window.rec_prds.pageSize);
            setTimeout(function(){
                that.loadRecPrds(2, window.rec_prds.pageSize);
            },300)
具体思路是先参数可配置化，一页展示4个商品，配合rem布局计算实际每个li的宽度和一页的宽度，
接下来先请求第一，第二页，iscroll可滑动，需要内容部分大于外部wrapper，iscroll自己计算并生成maxScrollX/maxScrollY。
所以需要先请求两页。
左右滑时候根据this.x和pagesize来计算当前页码，并保存。
每次翻页时判断是否有下一页，没有则加载。并销毁2页之前的商品并记录销毁状态，以便滑回的时候二次加载，
这样就保证页面每次只留存3页，每页4个品，一共12个品，利用chrome的profile 录制一段操作，也可以看到推荐商品部分的repaint最多只会重复12次.
推荐商品接口计算曝光率的逻辑有点奇葩，每次请求接口就算曝光，所以只能删除掉原来的节点内容，再次请求，而不是把图片逆向Lazyload化。。。
其中有一难点在后台处理无限加载的页码，因为前端每次都是加载下一页，而实际的页码是后端返回lastpage，前端每次请求前根据上次返回的lastpage作为请求参数。
其中还有一些bug fix 针对滑动停止时前后页因为惯性滚动而越过去的情况，不过后来把惯性滚动关了就好了...

有些遗憾 没有利用上require进行模块加载，虽然我把能独立的模块用Mod_来命名...不过还是有必然轮播组件没有抽出..

下篇文章说说优化吧。

